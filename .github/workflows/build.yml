name: Build A8E

on:
  push:
    branches: ["main", "master"]
    tags: ["v*"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build-linux:
    name: Linux (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake libsdl1.2-dev

      - name: Configure and Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j4

      - name: Package binary (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          mkdir -p dist
          cp build/A8E/A8E "dist/A8E-${GITHUB_REF_NAME}-linux"
          chmod +x "dist/A8E-${GITHUB_REF_NAME}-linux"

      - name: Upload artifact (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: A8E-linux
          path: dist/A8E-${{ github.ref_name }}-linux

  build-macos:
    name: macOS (Homebrew)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: brew install cmake sdl12-compat

      - name: Configure and Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j4

      - name: Package binary (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          mkdir -p dist
          cp build/A8E/A8E "dist/A8E-${GITHUB_REF_NAME}-macos"
          chmod +x "dist/A8E-${GITHUB_REF_NAME}-macos"

      - name: Upload artifact (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: A8E-macos
          path: dist/A8E-${{ github.ref_name }}-macos

  build-windows-msvc:
    name: Windows (MSVC)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install SDL via vcpkg
        # Note: vcpkg is pre-installed on GitHub's windows-latest runners!
        run: vcpkg install sdl1:x64-windows-static

      - name: Configure CMake
        run: >
          cmake -S . -B build/msvc
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET=x64-windows-static
          -DCMAKE_MSVC_RUNTIME_LIBRARY="MultiThreaded$<$<CONFIG:Debug>:Debug>"

      - name: Build
        run: cmake --build build/msvc --config Release

      - name: Package binary (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "build/msvc/A8E/Release/A8E.exe" "dist/A8E-$env:GITHUB_REF_NAME-windows-msvc.exe"

      - name: Upload artifact (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: A8E-windows-msvc
          path: dist/A8E-${{ github.ref_name }}-windows-msvc.exe

  build-windows-mingw:
    name: Windows (MinGW / MSYS2)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-SDL

      - name: Configure and Build
        run: |
          cmake -S . -B build/mingw -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXE_LINKER_FLAGS="-static"
          cmake --build build/mingw -j4

      - name: Package binary (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          mkdir -p dist
          cp build/mingw/A8E/A8E.exe "dist/A8E-${GITHUB_REF_NAME}-windows-mingw.exe"

      - name: Upload artifact (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: A8E-windows-mingw
          path: dist/A8E-${{ github.ref_name }}-windows-mingw.exe

  publish-release:
    name: Publish GitHub Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - build-linux
      - build-macos
      - build-windows-msvc
      - build-windows-mingw
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          overwrite_files: true
          files: |
            release-assets/A8E-linux/A8E-${{ github.ref_name }}-linux
            release-assets/A8E-macos/A8E-${{ github.ref_name }}-macos
            release-assets/A8E-windows-msvc/A8E-${{ github.ref_name }}-windows-msvc.exe
            release-assets/A8E-windows-mingw/A8E-${{ github.ref_name }}-windows-mingw.exe
